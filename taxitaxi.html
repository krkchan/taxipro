
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAGI TAXI - Dynamic Target</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#000000',
                        'dark-card': '#121212',
                        'dark-input': '#1e1e1e',
                        'dark-text': '#e0e0e0',
                    }
                }
            }
        }
    </script>
    <style>
        .stat-value { font-variant-numeric: tabular-nums; }
        button { touch-action: manipulation; }
        .blink-dot { animation: blink 2s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg text-gray-900 dark:text-dark-text transition-colors duration-200 pb-32">
    
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="fixed top-0 left-0 right-0 bg-white/95 dark:bg-dark-card/95 backdrop-blur z-40 border-b border-gray-200 dark:border-gray-800 shadow-sm px-4 py-2 flex justify-between items-center">
        <div>
            <p class="text-[10px] text-gray-500 dark:text-gray-400">ç¾åœ¨æ™‚åˆ»</p>
            <p class="text-xl font-bold font-mono leading-none tracking-tight" id="clockDisplay">--:--</p>
        </div>
        <div class="text-right">
            <p class="text-[10px] text-gray-500 dark:text-gray-400">å–¶æ¥­æ—¥æ‰±ã„</p>
            <p class="text-sm font-bold text-indigo-600 dark:text-indigo-400" id="logicalDateDisplay">--/-- (--)</p>
        </div>
    </div>

    <div class="container mx-auto px-3 pt-20 max-w-lg">
        
        <!-- ã‚·ãƒ•ãƒˆæƒ…å ± -->
        <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm p-4 mb-3 border-l-4 border-indigo-500">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-xs font-bold text-gray-400 mb-1">ç¾åœ¨ã®ã‚·ãƒ•ãƒˆ</h2>
                    <div class="flex items-baseline gap-2">
                        <span id="shiftStatus" class="text-3xl font-black text-indigo-600 dark:text-indigo-400">--</span>
                        <span id="nextOff" class="text-xs font-bold text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">--</span>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 mb-1">ã‚·ãƒ•ãƒˆèª¿æ•´</p>
                    <div class="flex bg-gray-100 dark:bg-gray-800 rounded-lg p-1 gap-1">
                        <button onclick="adjustShift(-1)" class="w-8 h-8 flex items-center justify-center bg-white dark:bg-dark-input rounded shadow text-gray-600 dark:text-gray-300 font-bold active:scale-95">â—€</button>
                        <button onclick="adjustShift(1)" class="w-8 h-8 flex items-center justify-center bg-white dark:bg-dark-input rounded shadow text-gray-600 dark:text-gray-300 font-bold active:scale-95">â–¶</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»Šæ—¥ã®å£²ä¸Š & ç›®æ¨™åˆ†æï¼ˆã“ã“ã‚’å¼·åŒ–ï¼‰ -->
        <div class="bg-white dark:bg-dark-card rounded-xl shadow-lg p-4 mb-4 border-l-4 border-green-500">
            <!-- ä¸Šæ®µ: å£²ä¸Š -->
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-xs font-bold text-gray-500 uppercase flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 blink-dot"></span> ç¾åœ¨ã®å£²ä¸Š
                </h2>
                <span id="todayAchievement" class="text-xl font-black text-green-600 dark:text-green-400 stat-value">0%</span>
            </div>
            <div class="flex items-baseline gap-2 mb-3 border-b border-gray-100 dark:border-gray-800 pb-3">
                <p class="text-5xl font-black text-gray-900 dark:text-white stat-value tracking-tighter" id="todayTotal">0</p>
                <span class="text-sm font-bold text-gray-400">å††</span>
            </div>

            <!-- ä¸­æ®µ: ãƒãƒ«ãƒåˆ†æ -->
            <div class="space-y-3">
                <!-- 1. åŸºæœ¬ãƒãƒ«ãƒ -->
                <div class="flex justify-between items-center text-xs">
                    <span class="text-gray-500">å½“åˆã®å‡ç­‰ãƒãƒ«ãƒ:</span>
                    <span class="font-bold text-gray-700 dark:text-gray-300 text-sm">Â¥<span id="staticTarget">0</span></span>
                </div>

                <!-- 2. å‹•çš„ãƒãƒ«ãƒï¼ˆã“ã“ãŒæ–°æ©Ÿèƒ½ï¼‰ -->
                <div class="bg-gray-50 dark:bg-gray-800/60 rounded-lg p-2.5">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-gray-600 dark:text-gray-400">æ˜æ—¥ä»¥é™ã®å¿…è¦å¹³å‡</span>
                        <span class="text-xs font-bold bg-white dark:bg-gray-700 px-2 py-0.5 rounded shadow-sm text-gray-500">æ®‹ã‚Š <span id="futureDaysCount">0</span> æ—¥</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-xl font-black stat-value transition-colors duration-300" id="dynamicTarget">Â¥0</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-gray-400">å½“åˆæ¯”</p>
                            <p class="text-xs font-bold stat-value" id="targetDiff">Â±0</p>
                        </div>
                    </div>
                    <p class="text-[10px] text-right mt-1 text-gray-400" id="dynamicMessage">--</p>
                </div>
            </div>
            
            <div class="text-right mt-2 text-[10px] text-gray-400">
                æœˆè¨ˆ: <span id="monthlyTotal">0</span>å††
            </div>
        </div>

        <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="bg-white dark:bg-dark-card rounded-xl shadow-lg p-5 mb-6">
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2">ç¾åœ¨ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼åˆè¨ˆé‡‘é¡</label>
                <div class="relative">
                    <input type="number" id="meterAmount" inputmode="numeric" class="w-full pl-4 pr-4 py-4 text-3xl font-bold bg-gray-100 dark:bg-dark-input border-2 border-transparent focus:border-blue-500 dark:text-white rounded-xl outline-none placeholder-gray-400 text-center" placeholder="0">
                </div>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <button onclick="handleUpdateCurrent()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl shadow-lg active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                    <span class="text-2xl">ğŸ”„</span>
                    <div class="text-left leading-tight">
                        <div class="text-lg font-bold">ç¾åœ¨ã¾ã§ã®å£²ä¸Šã‚’æ›´æ–°</div>
                        <div class="text-xs opacity-80 font-normal">ä¼‘æ†©ä¸­ãƒ»å¾…æ©Ÿä¸­ã«ã‚¿ãƒƒãƒ—</div>
                    </div>
                </button>

                <button onclick="handleEndShift()" class="w-full bg-gray-800 dark:bg-red-900/40 hover:bg-gray-900 dark:hover:bg-red-900/60 border border-gray-200 dark:border-red-900 text-white dark:text-red-200 py-4 rounded-xl active:scale-[0.98] transition-all flex items-center justify-center gap-3 mt-2">
                    <span class="text-2xl">ğŸ›‘</span>
                    <div class="text-left leading-tight">
                        <div class="text-lg font-bold">æ¥­å‹™çµ‚äº†ï¼ˆç¢ºå®šï¼‰</div>
                        <div class="text-xs opacity-80 font-normal">æœ¬æ—¥ã®å–¶æ¥­ã‚’ç· ã‚åˆ‡ã‚‹</div>
                    </div>
                </button>
            </div>
        </div>

        <!-- é€±é–“ã‚°ãƒ©ãƒ• -->
        <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm p-4 mb-6">
            <h3 class="text-xs font-bold text-gray-400 mb-2">WEEKLY TREND</h3>
            <div class="h-40">
                <canvas id="weeklyChart"></canvas>
            </div>
        </div>

        <!-- å…¬å‡ºãƒ»ä¿®æ­£ -->
        <details class="mb-24 bg-gray-100 dark:bg-dark-input rounded-xl overflow-hidden">
            <summary class="p-4 text-xs font-bold text-gray-600 dark:text-gray-400 cursor-pointer select-none flex justify-between items-center">
                <span>ğŸ› ï¸ å…¬å‡º / ä¿®æ­£</span>
                <span>â–¼</span>
            </summary>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 space-y-6">
                <div>
                    <h4 class="text-xs font-bold text-indigo-500 mb-2">å…¬å‡ºï¼ˆè‡¨æ™‚ï¼‰</h4>
                    <div class="flex gap-2">
                        <input type="date" id="koshutsuDate" class="w-1/3 p-2 text-xs rounded dark:bg-dark-card dark:text-white border dark:border-gray-700">
                        <input type="number" id="koshutsuAmount" class="w-2/3 p-2 text-sm font-bold rounded dark:bg-dark-card dark:text-white border dark:border-gray-700" placeholder="é‡‘é¡">
                    </div>
                    <button onclick="handleKoshutsuSubmit()" class="mt-2 w-full bg-indigo-600 text-white text-xs font-bold py-2 rounded">è¿½åŠ ã®ã¿</button>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-orange-500 mb-2">éå»ä¿®æ­£</h4>
                    <div class="flex gap-2 mb-2">
                        <input type="date" id="editDate" class="w-1/3 p-2 text-xs rounded dark:bg-dark-card dark:text-white border dark:border-gray-700">
                        <input type="number" id="editAmount" class="w-2/3 p-2 text-sm font-bold rounded dark:bg-dark-card dark:text-white border dark:border-gray-700" placeholder="é‡‘é¡">
                    </div>
                    <button onclick="handlePastSubmit()" class="w-full bg-orange-500 text-white text-xs font-bold py-2 rounded">ä¸Šæ›¸ãä¿å­˜</button>
                </div>
            </div>
        </details>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-card border-t dark:border-gray-800 p-3 z-30 pb-safe">
            <div class="container mx-auto max-w-lg flex justify-between items-center">
                <div class="flex gap-2">
                    <button onclick="setTarget(600000)" class="target-btn px-2 py-1 text-[10px] rounded border dark:border-gray-700 dark:text-gray-300">60ä¸‡</button>
                    <button onclick="setTarget(700000)" class="target-btn px-2 py-1 text-[10px] rounded border dark:border-gray-700 dark:text-gray-300">70ä¸‡</button>
                    <button onclick="setTarget(800000)" class="target-btn px-2 py-1 text-[10px] rounded border dark:border-gray-700 dark:text-gray-300">80ä¸‡</button>
                </div>
                <button onclick="toggleDark()" class="text-xs p-2">ğŸŒ™</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            anchorDate: new Date(2026, 1, 8),
            anchorIndex: 3,
            pattern: [1, 1, 1, 1, 0, 0],
            cutoffHour: 6
        };

        let STATE = {
            revenue: JSON.parse(localStorage.getItem('taxi_rev_dynamic') || '[]'),
            target: parseInt(localStorage.getItem('taxi_target_dynamic') || '600000'),
            offset: parseInt(localStorage.getItem('taxi_offset_dynamic') || '0')
        };

        function getNow() { return new Date(); }
        function getLogicalDate() {
            const now = getNow();
            if (now.getHours() < CONFIG.cutoffHour) {
                const prev = new Date(now);
                prev.setDate(now.getDate() - 1);
                return prev;
            }
            return now;
        }
        function getDateStr(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

        function getShiftStatus(logicalDate) {
            const t = new Date(logicalDate.getFullYear(), logicalDate.getMonth(), logicalDate.getDate());
            const a = new Date(CONFIG.anchorDate.getFullYear(), CONFIG.anchorDate.getMonth(), CONFIG.anchorDate.getDate());
            let idx = (CONFIG.anchorIndex + Math.floor((t-a)/(86400000)) + STATE.offset) % 6;
            if (idx < 0) idx += 6;
            const isWork = CONFIG.pattern[idx] === 1;
            return { isWork, idx, label: isWork ? `${idx+1}æ—¥ç›®` : `ä¼‘æ—¥(${idx-3}æ—¥ç›®)` };
        }

        // æœˆã®å…¨å–¶æ¥­æ—¥æ•°ã¨ã€æ˜æ—¥ä»¥é™ã®å–¶æ¥­æ—¥æ•°ã‚’è¨ˆç®—
        function calcWorkDays(logicalDate) {
            const y = logicalDate.getFullYear(), m = logicalDate.getMonth();
            const lastDay = new Date(y, m + 1, 0).getDate();
            
            let total = 0;
            let future = 0; // æ˜æ—¥ä»¥é™ã®å–¶æ¥­æ—¥æ•°

            for(let d=1; d<=lastDay; d++) {
                const chk = new Date(y, m, d);
                const isW = getShiftStatus(chk).isWork || STATE.revenue.some(r=>r.date===getDateStr(chk)&&r.isKoshutsu);
                
                if(isW) {
                    total++;
                    if(d > logicalDate.getDate()) future++;
                }
            }
            return { total, future };
        }

        function render() {
            const now = getNow();
            const lDate = getLogicalDate();
            const lDateStr = getDateStr(lDate);
            const monthStr = lDateStr.substring(0, 7);

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
            document.getElementById('clockDisplay').textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            document.getElementById('logicalDateDisplay').textContent = `${lDate.getMonth()+1}/${lDate.getDate()} (${days[lDate.getDay()]})æ‰±ã„`;

            // ã‚·ãƒ•ãƒˆ
            const shift = getShiftStatus(lDate);
            const sEl = document.getElementById('shiftStatus');
            sEl.textContent = shift.label;
            sEl.className = shift.isWork ? "text-3xl font-black text-indigo-600 dark:text-indigo-400" : "text-3xl font-black text-red-500 dark:text-red-400";
            document.getElementById('nextOff').textContent = shift.isWork ? (4-shift.idx===1?"æ˜æ—¥ä¼‘":`ã‚ã¨${4-shift.idx}æ—¥`) : "ä¼‘ã¿";

            // å£²ä¸Šè¨ˆç®—
            const todayRecord = STATE.revenue.find(r => r.date === lDateStr && !r.isKoshutsu);
            const todayAmt = todayRecord ? todayRecord.amount : 0;
            const monthTotal = STATE.revenue.filter(r => r.date.startsWith(monthStr)).reduce((sum, r) => sum + r.amount, 0);

            // ç›®æ¨™è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
            const workStats = calcWorkDays(lDate);
            const staticDailyTarget = Math.round(STATE.target / (workStats.total || 1));
            
            // å‹•çš„ç›®æ¨™ï¼ˆæ˜æ—¥ä»¥é™ï¼‰
            // æ®‹ã‚Šã®å¿…è¦é‡‘é¡ = (æœˆç›®æ¨™) - (ä»Šæ—¥ã‚’å«ã‚ãŸä»Šæœˆã®å£²ä¸Š)
            // ã“ã‚Œã‚’ (æ˜æ—¥ä»¥é™ã®å–¶æ¥­æ—¥æ•°) ã§å‰²ã‚‹
            const remainingNeeded = STATE.target - monthTotal;
            let dynamicDailyTarget = 0;
            
            if (workStats.future > 0) {
                // ã¾ã æœªæ¥ã®å–¶æ¥­æ—¥ãŒã‚ã‚‹å ´åˆ
                // â€»ä»Šæ—¥ã‚‚ã®ã™ã”ã„ç¨¼ã„ã§remainingãŒãƒã‚¤ãƒŠã‚¹ã«ãªã£ãŸå ´åˆã€0å††ã«ã™ã‚‹ã‹ãƒã‚¤ãƒŠã‚¹ã‚’è¡¨ç¤ºã™ã‚‹ã‹ï¼Ÿ
                // -> 0å††ï¼ˆé”æˆæ¸ˆï¼‰è¡¨ç¤ºãŒè‰¯ã„
                dynamicDailyTarget = Math.max(0, Math.round(remainingNeeded / workStats.future));
            } else {
                // æœˆæœ«ï¼ˆæ˜æ—¥ä»¥é™ãŒãªã„ï¼‰ã®å ´åˆã€æ®‹ã‚Šã¯å…¨éƒ¨ä»Šæ—¥ã®ãƒãƒ«ãƒ...ã§ã¯ãªãã€é”æˆã‹æœªé”ã‹ã®è¡¨ç¤ºã«ãªã‚‹ã¹ã
                dynamicDailyTarget = 0; 
            }

            // UIåæ˜ 
            document.getElementById('todayTotal').textContent = todayAmt.toLocaleString();
            document.getElementById('todayAchievement').textContent = `${Math.round((todayAmt/staticDailyTarget)*100)}%`;
            document.getElementById('monthlyTotal').textContent = monthTotal.toLocaleString();
            document.getElementById('staticTarget').textContent = staticDailyTarget.toLocaleString();

            // å‹•çš„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®è¡¨ç¤ºåˆ¶å¾¡
            const dTargetEl = document.getElementById('dynamicTarget');
            const dDiffEl = document.getElementById('targetDiff');
            const dMsgEl = document.getElementById('dynamicMessage');
            
            document.getElementById('futureDaysCount').textContent = workStats.future;

            if (workStats.future === 0) {
                dTargetEl.textContent = "---";
                dDiffEl.textContent = "";
                dMsgEl.textContent = "ä»Šæœˆæœ€å¾Œã®å–¶æ¥­æ—¥ã§ã™";
            } else {
                dTargetEl.textContent = `Â¥${dynamicDailyTarget.toLocaleString()}`;
                
                const diff = dynamicDailyTarget - staticDailyTarget;
                if (diff <= 0) {
                    // æ¥½ã«ãªã£ã¦ã‚‹ï¼ˆç›®æ¨™ã‚ˆã‚Šä½ã„é¡ã§OKï¼‰
                    dTargetEl.className = "text-xl font-black stat-value text-blue-500 dark:text-blue-400";
                    dDiffEl.textContent = `â–¼ Â¥${Math.abs(diff).toLocaleString()}`;
                    dDiffEl.className = "text-xs font-bold stat-value text-blue-500";
                    dMsgEl.textContent = "é †èª¿ã§ã™ï¼æ˜æ—¥ä»¥é™ã®è² æ‹…ãŒæ¸›ã‚Šã¾ã—ãŸ";
                } else {
                    // ãã¤ããªã£ã¦ã‚‹ï¼ˆç›®æ¨™ã‚ˆã‚Šé«˜ã„é¡ãŒå¿…è¦ï¼‰
                    dTargetEl.className = "text-xl font-black stat-value text-red-500 dark:text-orange-400";
                    dDiffEl.textContent = `â–² Â¥${diff.toLocaleString()}`;
                    dDiffEl.className = "text-xs font-bold stat-value text-red-500 dark:text-orange-400";
                    dMsgEl.textContent = "æ˜æ—¥ä»¥é™ã€å°‘ã—ãƒšãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã™";
                }
            }

            // ã‚¤ãƒ³ãƒ—ãƒƒãƒˆåŒæœŸ
            const input = document.getElementById('meterAmount');
            if(document.activeElement !== input && todayAmt > 0) input.value = todayAmt;

            // ã‚°ãƒ©ãƒ•
            updateChart(staticDailyTarget, lDate);

            // ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸå€¤
            if(!document.getElementById('koshutsuDate').value) document.getElementById('koshutsuDate').value = getDateStr(now);
            if(!document.getElementById('editDate').value) document.getElementById('editDate').value = lDateStr;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ç¾¤ï¼ˆå‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒç­‰ï¼‰
        window.handleUpdateCurrent = () => {
            const amt = parseInt(document.getElementById('meterAmount').value);
            if(isNaN(amt)) return;
            const dStr = getDateStr(getLogicalDate());
            const idx = STATE.revenue.findIndex(r => r.date === dStr && !r.isKoshutsu);
            if(idx >= 0) { STATE.revenue[idx].amount = amt; STATE.revenue[idx].time = new Date().toTimeString().slice(0,5); }
            else { STATE.revenue.push({ id:Date.now(), date:dStr, time:new Date().toTimeString().slice(0,5), amount:amt, isKoshutsu:false }); }
            saveData();
            // Feedback
            const btn = document.activeElement;
            const org = btn.innerHTML;
            btn.innerHTML = "<span class='text-2xl'>âœ…</span> è¨ˆç®—å®Œäº†";
            setTimeout(()=>btn.innerHTML=org, 800);
        };

        window.handleEndShift = () => {
            const amt = parseInt(document.getElementById('meterAmount').value);
            if(isNaN(amt)) return alert("é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            const lDate = getLogicalDate();
            if(!confirm(`${lDate.getMonth()+1}/${lDate.getDate()}ã®å£²ä¸Šã‚’ Â¥${amt.toLocaleString()} ã§ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ`)) return;
            const idx = STATE.revenue.findIndex(r => r.date === getDateStr(lDate) && !r.isKoshutsu);
            if(idx>=0) STATE.revenue[idx].amount = amt;
            else STATE.revenue.push({ id:Date.now(), date:getDateStr(lDate), amount:amt, isKoshutsu:false });
            saveData();
            alert("ç¢ºå®šã—ã¾ã—ãŸ");
        };

        window.handleKoshutsuSubmit = () => {
            const d = document.getElementById('koshutsuDate').value;
            const a = parseInt(document.getElementById('koshutsuAmount').value);
            if(!d || !a) return alert("ä¸å‚™ã‚ã‚Š");
            STATE.revenue.push({ id:Date.now(), date:d, amount:a, isKoshutsu:true });
            saveData();
            alert("å…¬å‡ºè¿½åŠ ");
            document.getElementById('koshutsuAmount').value='';
        };

        window.handlePastSubmit = () => {
            const d = document.getElementById('editDate').value;
            const a = parseInt(document.getElementById('editAmount').value);
            if(!d || isNaN(a)) return;
            if(!confirm("ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ")) return;
            STATE.revenue = STATE.revenue.filter(r => !(r.date===d && !r.isKoshutsu));
            if(a>0) STATE.revenue.push({ id:Date.now(), date:d, amount:a, isKoshutsu:false });
            saveData();
            alert("ä¿®æ­£å®Œäº†");
        };

        window.adjustShift = v => { STATE.offset+=v; localStorage.setItem('taxi_offset_dynamic', STATE.offset); render(); };
        window.setTarget = v => { STATE.target=v; saveData(); };
        function saveData() { localStorage.setItem('taxi_rev_dynamic', JSON.stringify(STATE.revenue)); localStorage.setItem('taxi_target_dynamic', STATE.target); render(); }
        
        let chart;
        function updateChart(target, lDate) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            const labels=[], data=[];
            for(let i=6; i>=0; i--){
                const d = new Date(lDate); d.setDate(d.getDate()-i);
                labels.push(`${d.getDate()}æ—¥`);
                data.push(STATE.revenue.filter(r=>r.date===getDateStr(d)).reduce((a,b)=>a+b.amount,0));
            }
            if(chart) { chart.data.labels=labels; chart.data.datasets[0].data=data; chart.data.datasets[1].data=Array(7).fill(target); chart.update(); }
            else { chart = new Chart(ctx, { type:'bar', data:{labels,datasets:[{label:'å£²ä¸Š',data,backgroundColor:'#4f46e5',borderRadius:4},{type:'line',label:'ç›®æ¨™',data:Array(7).fill(target),borderColor:'#ef4444',borderDash:[5,5],pointRadius:0}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{display:false}}} }); }
        }

        function toggleDark(){ document.documentElement.classList.toggle('dark'); localStorage.setItem('dark', document.documentElement.classList.contains('dark')?'1':'0'); }
        if(localStorage.getItem('dark')==='1') document.documentElement.classList.add('dark');
        setInterval(render, 30000); render();
    </script>
</body>
</html>
