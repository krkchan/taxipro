
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœŸæ—¥å‡ºå‹¤å¯¾å¿œã‚¿ã‚¯ã‚·ãƒ¼ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#1a1a1a',
                        'dark-card': '#2d2d2d',
                        'dark-text': '#e0e0e0',
                        'dark-border': '#404040'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-dark-bg text-gray-900 dark:text-dark-text transition-colors duration-300">
    <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
    <div class="fixed top-4 right-4 z-50">
        <button id="darkModeToggle" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            <span class="text-xl">ğŸŒ™</span>
        </button>
    </div>

    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- ä»Šæ—¥ã®æ—¥ä»˜è¡¨ç¤ºï¼ˆä¸€ç•ªä¸Šã«æ˜ç¢ºã«ï¼‰ -->
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-dark-text mb-1">ğŸš• åœŸæ—¥å‡ºå‹¤å¯¾å¿œã‚¿ã‚¯ã‚·ãƒ¼ç®¡ç†</h1>
            <p class="text-sm text-gray-600 dark:text-gray-400">
                ä»Šæ—¥: <span id="todayDate" class="font-semibold"></span> | 
                <span id="todayWorkDayCalc" class="font-semibold text-blue-600 dark:text-blue-400"></span>
            </p>
        </div>
        
        <!-- ğŸ¯ ä¸€ç•ªè¦‹ãŸã„æƒ…å ±ã‚’æœ€ä¸Šéƒ¨ã«é›†ç´„ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            <!-- ä»Šæœˆã®çŠ¶æ³ -->
            <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg text-center">
                <p class="text-xs text-gray-600 dark:text-gray-300">ä»Šæœˆå£²ä¸Š</p>
                <p class="text-lg font-bold text-blue-600 dark:text-blue-400" id="currentMonthRevenue">Â¥0</p>
                <p class="text-xs text-gray-500 dark:text-gray-400" id="monthAchievement">0%</p>
            </div>
            
            <!-- ä»Šæ—¥ã®çŠ¶æ³ -->
            <div class="bg-green-50 dark:bg-green-900 p-3 rounded-lg text-center">
                <p class="text-xs text-gray-600 dark:text-gray-300">ä»Šæ—¥å£²ä¸Š</p>
                <p class="text-lg font-bold text-green-600 dark:text-green-400" id="todayRevenue">Â¥0</p>
                <p class="text-xs text-gray-500 dark:text-gray-400" id="todayAchievement">0%</p>
            </div>
            
            <!-- å–¶æ¥­æƒ…å ±ï¼ˆè©³ç´°ç‰ˆï¼‰ -->
            <div class="bg-orange-50 dark:bg-orange-900 p-3 rounded-lg text-center">
                <p class="text-xs text-gray-600 dark:text-gray-300">å–¶æ¥­æƒ…å ±</p>
                <p class="text-lg font-bold text-orange-600 dark:text-orange-400" id="todayWorkInfo">0æ—¥ç›®</p>
                <p class="text-xs text-gray-500 dark:text-gray-400" id="workStatus">ä¼‘æ—¥</p>
            </div>
            
            <!-- æœˆé–“æƒ…å ± -->
            <div class="bg-purple-50 dark:bg-purple-900 p-3 rounded-lg text-center">
                <p class="text-xs text-gray-600 dark:text-gray-300">æœˆé–“æƒ…å ±</p>
                <p class="text-lg font-bold text-purple-600 dark:text-purple-400" id="monthlyInfo">0/0æ—¥</p>
                <p class="text-xs text-gray-500 dark:text-gray-400" id="remainingInfo">æ®‹ã‚Š0æ—¥</p>
            </div>
        </div>

        <!-- ğŸ”§ æ‰‹å‹•ä¿®æ­£ãƒœã‚¿ãƒ³ -->
        <div class="bg-yellow-50 dark:bg-yellow-900 rounded-lg shadow-md p-4 mb-4 border border-yellow-200 dark:border-yellow-700">
            <h2 class="text-lg font-semibold mb-3 text-yellow-800 dark:text-yellow-300">ğŸ”§ å–¶æ¥­æ—¥ä¿®æ­£</h2>
            <p class="text-sm text-yellow-700 dark:text-yellow-400 mb-3">è¨ˆç®—ãŒã‚ºãƒ¬ã¦ã„ã‚‹å ´åˆã¯ã“ã“ã§ä¿®æ­£ã—ã¦ãã ã•ã„ï¼ˆä»¥é™è‡ªå‹•ã§å†è¨ˆç®—ï¼‰</p>
            <div class="flex gap-3 items-center">
                <div>
                    <label class="block text-xs font-medium text-yellow-800 dark:text-yellow-300 mb-1">ä»Šæ—¥ã‚’ä½•æ—¥ç›®ã«ä¿®æ­£ï¼Ÿ</label>
                    <select id="manualWorkDay" class="px-3 py-2 border border-yellow-300 dark:border-yellow-600 rounded-md bg-white dark:bg-gray-700 text-sm">
                        <option value="1">1æ—¥ç›®</option>
                        <option value="2">2æ—¥ç›®</option>
                        <option value="3">3æ—¥ç›®</option>
                        <option value="4">4æ—¥ç›®</option>
                        <option value="5">5æ—¥ç›®</option>
                        <option value="6">6æ—¥ç›®</option>
                        <option value="7">7æ—¥ç›®</option>
                        <option value="8">8æ—¥ç›®</option>
                        <option value="9">9æ—¥ç›®</option>
                        <option value="10">10æ—¥ç›®</option>
                    </select>
                </div>
                <button onclick="fixWorkDay()" class="bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded-md transition duration-200 text-sm font-medium">
                    ä¿®æ­£ã—ã¦å†è¨ˆç®—
                </button>
                <button onclick="resetToDefault()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-md transition duration-200 text-sm">
                    ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
                </button>
            </div>
            <div id="manualFixInfo" class="mt-2 text-xs text-yellow-700 dark:text-yellow-400"></div>
        </div>

        <!-- æœˆé–“ç›®æ¨™é¸æŠ -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-4 border border-gray-200 dark:border-dark-border">
            <div class="flex flex-wrap gap-2 justify-center">
                <button onclick="setMonthlyTarget(500000)" class="monthly-target-btn px-3 py-2 rounded-lg bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 dark:hover:bg-blue-800 text-blue-700 dark:text-blue-300 text-sm" data-target="500000">50ä¸‡</button>
                <button onclick="setMonthlyTarget(600000)" class="monthly-target-btn px-3 py-2 rounded-lg bg-green-100 dark:bg-green-900 hover:bg-green-200 dark:hover:bg-green-800 text-green-700 dark:text-green-300 text-sm" data-target="600000">60ä¸‡</button>
                <button onclick="setMonthlyTarget(700000)" class="monthly-target-btn px-3 py-2 rounded-lg bg-yellow-100 dark:bg-yellow-900 hover:bg-yellow-200 dark:hover:bg-yellow-800 text-yellow-700 dark:text-yellow-300 text-sm" data-target="700000">70ä¸‡</button>
                <button onclick="setMonthlyTarget(800000)" class="monthly-target-btn px-3 py-2 rounded-lg bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 dark:hover:bg-purple-800 text-purple-700 dark:text-purple-300 text-sm" data-target="800000">80ä¸‡</button>
                <button onclick="setMonthlyTarget(900000)" class="monthly-target-btn px-3 py-2 rounded-lg bg-red-100 dark:bg-red-900 hover:bg-red-200 dark:hover:bg-red-800 text-red-700 dark:text-red-300 text-sm" data-target="900000">90ä¸‡</button>
            </div>
        </div>

        <!-- å£²ä¸Šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆï¼‰ -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-4 border border-gray-200 dark:border-dark-border">
            <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-dark-text">ğŸ’° å£²ä¸Šè¨˜éŒ²</h2>
            <form id="revenueForm" class="space-y-3">
                <div class="grid grid-cols-3 gap-3">
                    <input type="time" id="time" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-dark-text text-sm">
                    <input type="number" id="amount" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-dark-text text-sm" placeholder="é‡‘é¡">
                    <select id="dayOfWeek" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-dark-text text-sm">
                        <option value="æœˆ">æœˆ</option><option value="ç«">ç«</option><option value="æ°´">æ°´</option><option value="æœ¨">æœ¨</option><option value="é‡‘">é‡‘</option><option value="åœŸ">åœŸ</option><option value="æ—¥">æ—¥</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <input type="text" id="memo" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-dark-text text-sm" placeholder="ãƒ¡ãƒ¢ï¼ˆä¾‹: ç©ºæ¸¯ã€è¦³å…‰å®¢ï¼‰">
                    <label class="flex items-center text-sm"><input type="checkbox" id="isLongCustomer" class="mr-2"> ãƒ­ãƒ³ã‚°å®¢</label>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition duration-200 text-sm font-medium">
                    è¨˜éŒ²ã—ã¦åˆ†æã‚’å—ã‘ã‚‹
                </button>
            </form>
        </div>

        <!-- æœˆé–“å£²ä¸Šç›´æ¥å…¥åŠ›ï¼ˆå…¥åŠ›ã—å¿˜ã‚Œå¯¾ç­–ï¼‰ -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-4 border border-gray-200 dark:border-dark-border">
            <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-dark-text">âœï¸ æœˆé–“å£²ä¸Šç›´æ¥å…¥åŠ›ï¼ˆå…¥åŠ›å¿˜ã‚Œç”¨ï¼‰</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input type="date" id="directDate" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-dark-text text-sm">
                <input type="number" id="directAmount" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-dark-text text-sm" placeholder="å£²ä¸Šé‡‘é¡">
                <button onclick="saveDirectInput()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition duration-200 text-sm font-medium">
                    ç›´æ¥ä¿å­˜
                </button>
            </div>
            <div id="directInputInfo" class="mt-2 text-xs text-gray-600 dark:text-gray-400"></div>
        </div>

        <!-- é€±é–“ã‚°ãƒ©ãƒ• -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-4 border border-gray-200 dark:border-dark-border">
            <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-dark-text">ğŸ“Š é€±é–“å£²ä¸Šæ¨ç§»</h2>
            <canvas id="weeklyChart" width="400" height="150"></canvas>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿æ“ä½œ -->
        <div class="flex gap-3 justify-center mb-4">
            <button onclick="exportData()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-md transition duration-200 text-sm">
                ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›
            </button>
            <button onclick="clearData()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md transition duration-200 text-sm">
                ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
            </button>
        </div>

        <!-- ãƒ­ãƒ³ã‚°å®¢è¨˜éŒ²ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 border border-gray-200 dark:border-dark-border">
            <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-dark-text">ğŸ¯ æœ€è¿‘ã®ãƒ­ãƒ³ã‚°å®¢</h2>
            <div id="longCustomerList" class="space-y-2 max-h-48 overflow-y-auto text-sm">
                <p class="text-gray-500 dark:text-gray-400 text-center py-4">ãƒ­ãƒ³ã‚°å®¢ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>

        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºç”¨ï¼‰ -->
        <div id="debugInfo" class="hidden mt-4 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-xs text-gray-600 dark:text-gray-400">
            <h3 class="font-semibold mb-2">ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</h3>
            <div id="debugContent"></div>
        </div>
    </div>

    <script>
        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
        const darkModeToggle = document.getElementById('darkModeToggle');
        const html = document.documentElement;

        if (localStorage.getItem('darkMode') === 'true' || 
            (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
            darkModeToggle.innerHTML = 'â˜€ï¸';
        }

        darkModeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            darkModeToggle.innerHTML = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        });

        // ğŸ¯ **åœŸæ—¥å‡ºå‹¤å¯¾å¿œã®å®Œç’§ãªå–¶æ¥­æ—¥è¨ˆç®—ã‚¯ãƒ©ã‚¹**
        class WeekendWorkScheduleCalculator {
            constructor() {
                // 2026å¹´2æœˆ8æ—¥ã‚’4å‹¤å‹™ã®4æ—¥ç›®ã¨ã—ã¦è¨­å®šï¼ˆåœŸæ—¥å‡ºå‹¤å¯¾å¿œï¼‰
                this.baseDate = new Date(2026, 1, 8); // 2026å¹´2æœˆ8æ—¥
                this.baseWorkDay = 4; // 4æ—¥ç›®
                this.workPattern = [true, true, true, true, false, false]; // 4å‹¤å‹™2ä¼‘ã¿
                
                console.log('=== å–¶æ¥­æ—¥è¨ˆç®—åˆæœŸè¨­å®š ===');
                console.log('åŸºæº–æ—¥:', this.baseDate.toLocaleDateString('ja-JP'), 
                           'æ›œæ—¥:', ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][this.baseDate.getDay()],
                           'å–¶æ¥­æ—¥:', this.baseWorkDay + 'æ—¥ç›®');
            }

            // æœˆé–“ç·å–¶æ¥­æ—¥æ•°ã‚’æ­£ç¢ºã«è¨ˆç®—
            calculateTotalWorkDays(year, month) {
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                // åŸºæº–æ—¥ã‹ã‚‰ã®æ—¥æ•°å·®ã‚’è¨ˆç®—
                const diffTime = firstDay - this.baseDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ä½ç½®ã‚’è¨ˆç®—
                let patternIndex = (this.baseWorkDay - 1 + diffDays) % 6;
                if (patternIndex < 0) patternIndex += 6;
                
                let workDays = 0;
                let currentDate = new Date(firstDay);
                
                // æœˆã®å…¨æ—¥æ•°ã‚’ãƒã‚§ãƒƒã‚¯
                while (currentDate <= lastDay) {
                    if (this.workPattern[patternIndex]) {
                        workDays++;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                    patternIndex = (patternIndex + 1) % 6;
                }
                
                return workDays;
            }

            // ä»Šæ—¥ãŒä½•å‹¤å‹™ç›®ã‹ã‚’æ­£ç¢ºã«è¨ˆç®—
            getTodayWorkDayNumber(date) {
                // åŸºæº–æ—¥ã‹ã‚‰ã®æ—¥æ•°å·®ã‚’è¨ˆç®—
                const diffTime = date - this.baseDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³ä½ç½®ã‚’è¨ˆç®—
                let patternIndex = (this.baseWorkDay - 1 + diffDays) % 6;
                if (patternIndex < 0) patternIndex += 6;
                
                // åŸºæº–æ—¥ã‹ã‚‰ä»Šæ—¥ã¾ã§ã®å–¶æ¥­æ—¥ã‚’æ•°ãˆã‚‹
                let workDayIndex = 0;
                let currentDate = new Date(this.baseDate);
                let currentPatternIndex = (this.baseWorkDay - 1) % 6;
                
                while (currentDate <= date) {
                    if (this.workPattern[currentPatternIndex]) {
                        workDayIndex++;
                    }
                    if (currentDate.getTime() === date.getTime()) {
                        break;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                    currentPatternIndex = (currentPatternIndex + 1) % 6;
                }
                
                return workDayIndex;
            }

            // å–¶æ¥­æ—¥ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            isWorkDay(date) {
                const diffTime = date - this.baseDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const patternIndex = (this.baseWorkDay - 1 + diffDays) % 6;
                return this.workPattern[patternIndex >= 0 ? patternIndex : patternIndex + 6];
            }

            // æ®‹ã‚Šå–¶æ¥­æ—¥æ•°ã‚’è¨ˆç®—
            getRemainingWorkDays(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const totalWorkDays = this.calculateTotalWorkDays(year, month);
                const currentWorkDay = this.getTodayWorkDayNumber(date);
                return totalWorkDays - currentWorkDay;
            }

            // æ‰‹å‹•ã§åŸºæº–æ—¥ã‚’ä¿®æ­£
            setManualBaseDate(date, workDayNumber) {
                this.baseDate = new Date(date);
                this.baseWorkDay = workDayNumber;
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('manualBaseDate', this.baseDate.toISOString());
                localStorage.setItem('manualBaseWorkDay', this.baseWorkDay);
                
                console.log('æ‰‹å‹•ä¿®æ­£é©ç”¨:', this.baseDate.toLocaleDateString('ja-JP'), 'ã‚’', this.baseWorkDay, 'æ—¥ç›®ã«è¨­å®š');
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
            resetToDefault() {
                this.baseDate = new Date(2026, 1, 8); // 2026å¹´2æœˆ8æ—¥
                this.baseWorkDay = 4; // 4æ—¥ç›®
                
                localStorage.removeItem('manualBaseDate');
                localStorage.removeItem('manualBaseWorkDay');
                
                console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ:', this.baseDate.toLocaleDateString('ja-JP'), this.baseWorkDay, 'æ—¥ç›®');
            }

            // ä¿å­˜ã•ã‚ŒãŸæ‰‹å‹•ä¿®æ­£ã‚’èª­ã¿è¾¼ã‚€
            loadManualSettings() {
                const savedDate = localStorage.getItem('manualBaseDate');
                const savedWorkDay = localStorage.getItem('manualBaseWorkDay');
                
                if (savedDate && savedWorkDay) {
                    this.baseDate = new Date(savedDate);
                    this.baseWorkDay = parseInt(savedWorkDay);
                    
                    console.log('ä¿å­˜ã•ã‚ŒãŸæ‰‹å‹•ä¿®æ­£ã‚’é©ç”¨:', this.baseDate.toLocaleDateString('ja-JP'), this.baseWorkDay, 'æ—¥ç›®');
                }
            }

            // ä»Šæ—¥ã®æ—¥ä»˜æƒ…å ±ã‚’å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            getTodayInfo(date) {
                const workDayNumber = this.getTodayWorkDayNumber(date);
                const totalWorkDays = this.calculateTotalWorkDays(date.getFullYear(), date.getMonth());
                const remainingWorkDays = this.getRemainingWorkDays(date);
                
                return {
                    date: date.toLocaleDateString('ja-JP'),
                    dayOfWeek: ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()],
                    isWorkDay: this.isWorkDay(date),
                    workDayNumber: workDayNumber,
                    totalWorkDaysThisMonth: totalWorkDays,
                    remainingWorkDays: remainingWorkDays,
                    baseDate: this.baseDate.toLocaleDateString('ja-JP'),
                    baseWorkDay: this.baseWorkDay
                };
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        const workScheduleCalc = new WeekendWorkScheduleCalculator();
        let revenueData = JSON.parse(localStorage.getItem('taxiRevenue')) || [];
        let longCustomerData = JSON.parse(localStorage.getItem('longCustomerData')) || [];
        let currentMonthlyTarget = parseInt(localStorage.getItem('monthlyTarget')) || 600000;
        let weeklyChart = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä¿å­˜ã•ã‚ŒãŸæ‰‹å‹•ä¿®æ­£ã‚’èª­ã¿è¾¼ã‚€
            workScheduleCalc.loadManualSettings();
            
            updateAllDisplay();
            updateChart();
            
            // åˆæœŸå€¤è¨­å®š
            const now = new Date();
            document.getElementById('time').value = now.toTimeString().slice(0, 5);
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            document.getElementById('dayOfWeek').value = days[now.getDay()];
            document.getElementById('directDate').value = now.toISOString().split('T')[0];
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¡¨ç¤º
            updateTodayDate();
            
            // æ‰‹å‹•ä¿®æ­£ãƒœã‚¿ãƒ³ã®åˆæœŸå€¤ã‚’è¨­å®š
            const todayInfo = workScheduleCalc.getTodayInfo(new Date());
            document.getElementById('manualWorkDay').value = todayInfo.workDayNumber;
            
            // æœˆé–“ç›®æ¨™ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelector(`[data-target="${currentMonthlyTarget}"]`)?.classList.add('ring-2', 'ring-blue-500', 'bg-blue-600', 'text-white');
        });

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’æ›´æ–°
        function updateTodayDate() {
            const now = new Date();
            const todayInfo = workScheduleCalc.getTodayInfo(now);
            
            document.getElementById('todayDate').textContent = 
                `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ (${todayInfo.dayOfWeek}æ›œæ—¥)`;
            
            document.getElementById('todayWorkDayCalc').textContent = 
                todayInfo.isWorkDay ? `å–¶æ¥­${todayInfo.workDayNumber}æ—¥ç›®` : 'æœ¬æ—¥ã¯ä¼‘æ—¥';
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆé–‹ç™ºç”¨ï¼‰
            showDebugInfo(todayInfo);
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function showDebugInfo(todayInfo) {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = `
                <p>åŸºæº–æ—¥: ${todayInfo.baseDate} (${todayInfo.baseWorkDay}æ—¥ç›®)</p>
                <p>ä»Šæ—¥: ${todayInfo.date} (${todayInfo.dayOfWeek})</p>
                <p>å–¶æ¥­æ—¥åˆ¤å®š: ${todayInfo.isWorkDay ? 'å–¶æ¥­æ—¥' : 'ä¼‘æ—¥'}</p>
                <p>å–¶æ¥­æ—¥ç•ªå·: ${todayInfo.workDayNumber}æ—¥ç›®</p>
                <p>æœˆé–“ç·å–¶æ¥­æ—¥: ${todayInfo.totalWorkDaysThisMonth}æ—¥</p>
                <p>æ®‹ã‚Šå–¶æ¥­æ—¥: ${todayInfo.remainingWorkDays}æ—¥</p>
            `;
            
            // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
            // document.getElementById('debugInfo').classList.remove('hidden');
        }

        // æ‰‹å‹•ã§å–¶æ¥­æ—¥ã‚’ä¿®æ­£
        function fixWorkDay() {
            const manualWorkDay = parseInt(document.getElementById('manualWorkDay').value);
            const today = new Date();
            
            // æ‰‹å‹•ä¿®æ­£ã‚’é©ç”¨
            workScheduleCalc.setManualBaseDate(today, manualWorkDay);
            
            // å…¨è¡¨ç¤ºã‚’æ›´æ–°
            updateAllDisplay();
            updateChart();
            updateTodayDate();
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            document.getElementById('manualFixInfo').innerHTML = `
                <span class="text-green-600 dark:text-green-400">âœ… ä»Šæ—¥ã‚’${manualWorkDay}æ—¥ç›®ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚ä»¥é™è‡ªå‹•ã§è¨ˆç®—ã—ã¾ã™ã€‚</span>
            `;
            setTimeout(() => {
                document.getElementById('manualFixInfo').innerHTML = '';
            }, 3000);
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        function resetToDefault() {
            workScheduleCalc.resetToDefault();
            
            // å…¨è¡¨ç¤ºã‚’æ›´æ–°
            updateAllDisplay();
            updateChart();
            updateTodayDate();
            
            // æ‰‹å‹•ä¿®æ­£ãƒœã‚¿ãƒ³ã®å€¤ã‚’æ›´æ–°
            const todayInfo = workScheduleCalc.getTodayInfo(new Date());
            document.getElementById('manualWorkDay').value = todayInfo.workDayNumber;
            
            document.getElementById('manualFixInfo').innerHTML = `
                <span class="text-blue-600 dark:text-blue-400">âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸï¼ˆ2026å¹´2æœˆ8æ—¥ã‚’4æ—¥ç›®ã¨ã—ã¦è¨ˆç®—ï¼‰</span>
            `;
            setTimeout(() => {
                document.getElementById('manualFixInfo').innerHTML = '';
            }, 3000);
        }

        // å…¨è¡¨ç¤ºä¸€æ‹¬æ›´æ–°ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ç”¨ï¼‰
        function updateAllDisplay() {
            const now = new Date();
            const todayInfo = workScheduleCalc.getTodayInfo(now);
            
            // æœˆé–“æƒ…å ±ã‚’æ­£ç¢ºã«è¨ˆç®—
            const monthlyWorkDays = todayInfo.totalWorkDaysThisMonth;
            const todayWorkDay = todayInfo.workDayNumber;
            const dailyTarget = Math.round(currentMonthlyTarget / monthlyWorkDays);
            const isWorkDay = todayInfo.isWorkDay;
            const remainingWorkDays = todayInfo.remainingWorkDays;
            
            // ä»Šæœˆã®å£²ä¸Šã‚’è¨ˆç®—
            const currentMonthRevenue = revenueData
                .filter(record => {
                    const recordDate = new Date(record.date.replace(/\//g, '-'));
                    return recordDate.getFullYear() === now.getFullYear() && recordDate.getMonth() === now.getMonth();
                })
                .reduce((sum, record) => sum + record.amount, 0);
            
            const monthAchievement = Math.round((currentMonthRevenue / currentMonthlyTarget) * 100);
            
            // ä»Šæ—¥ã®å£²ä¸Šã‚’è¨ˆç®—
            const todayRevenue = revenueData
                .filter(record => record.date === now.toLocaleDateString('ja-JP'))
                .reduce((sum, record) => sum + record.amount, 0);
            
            const todayAchievement = Math.round((todayRevenue / dailyTarget) * 100);
            
            // ãƒ­ãƒ³ã‚°å®¢æ•°
            const todayLongCustomers = longCustomerData.filter(record => record.date === now.toLocaleDateString('ja-JP')).length;
            
            // è¡¨ç¤ºã‚’ä¸€æ‹¬æ›´æ–°
            document.getElementById('currentMonthRevenue').textContent = `Â¥${currentMonthRevenue.toLocaleString()}`;
            document.getElementById('monthAchievement').textContent = `${monthAchievement}%`;
            document.getElementById('todayRevenue').textContent = `Â¥${todayRevenue.toLocaleString()}`;
            document.getElementById('todayAchievement').textContent = `${todayAchievement}%`;
            document.getElementById('todayWorkInfo').textContent = `${todayWorkDay}æ—¥ç›®`;
            document.getElementById('monthlyInfo').textContent = `${todayWorkDay}/${monthlyWorkDays}æ—¥`;
            document.getElementById('remainingInfo').textContent = `æ®‹ã‚Š${remainingWorkDays}æ—¥`;
            document.getElementById('dailyTargetAmount').textContent = `Â¥${dailyTarget.toLocaleString()}`;
            
            // å–¶æ¥­æ—¥/ä¼‘æ—¥ã®è¡¨ç¤º
            if (!isWorkDay) {
                document.getElementById('workStatus').textContent = 'ä¼‘æ—¥';
                document.getElementById('workStatus').classList.add('text-red-500');
                document.getElementById('todayWorkInfo').innerHTML = '<span class="text-red-500">ä¼‘æ—¥</span>';
            } else {
                document.getElementById('workStatus').textContent = 'å–¶æ¥­æ—¥';
                document.getElementById('workStatus').classList.remove('text-red-500');
            }
            
            // ãƒ­ãƒ³ã‚°å®¢ãƒªã‚¹ãƒˆæ›´æ–°
            updateLongCustomerList();
        }

        // æœˆé–“ç›®æ¨™è¨­å®š
        function setMonthlyTarget(target) {
            currentMonthlyTarget = target;
            localStorage.setItem('monthlyTarget', target);
            
            // ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
            document.querySelectorAll('.monthly-target-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300');
            });
            document.querySelector(`[data-target="${target}"]`)?.classList.add('ring-2', 'ring-blue-500', 'bg-blue-600', 'text-white');
            
            // å…¨è¡¨ç¤ºã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
            updateAllDisplay();
        }

        // å£²ä¸Šè¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('revenueForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const time = document.getElementById('time').value;
            const amount = parseInt(document.getElementById('amount').value);
            const memo = document.getElementById('memo').value;
            const dayOfWeek = document.getElementById('dayOfWeek').value;
            const date = new Date().toLocaleDateString('ja-JP');
            const isLongCustomer = document.getElementById('isLongCustomer').checked;
            
            if (!amount || amount <= 0) {
                alert('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const record = {
                id: Date.now(),
                date: date,
                time: time,
                amount: amount,
                memo: memo,
                dayOfWeek: dayOfWeek,
                isLongCustomer: isLongCustomer,
                timestamp: new Date().toISOString()
            };
            
            revenueData.push(record);
            localStorage.setItem('taxiRevenue', JSON.stringify(revenueData));
            
            // ãƒ­ãƒ³ã‚°å®¢ã®å ´åˆ
            if (isLongCustomer) {
                const longCustomerRecord = {
                    id: record.id,
                    date: date,
                    time: time,
                    dayOfWeek: dayOfWeek,
                    amount: amount,
                    pickupLocation: 'è¨˜éŒ²æ¸ˆã¿',
                    dropoffLocation: 'è¨˜éŒ²æ¸ˆã¿',
                    customerType: memo || 'ä¸€èˆ¬',
                    distance: 0,
                    memo: memo
                };
                longCustomerData.push(longCustomerRecord);
                localStorage.setItem('longCustomerData', JSON.stringify(longCustomerData));
            }
            
            // å…¨è¡¨ç¤ºã‚’å³åº§ã«æ›´æ–°
            updateAllDisplay();
            updateChart();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            this.reset();
            document.getElementById('isLongCustomer').checked = false;
            
            // ç¾åœ¨æ™‚åˆ»ã‚’å†è¨­å®š
            const now = new Date();
            document.getElementById('time').value = now.toTimeString().slice(0, 5);
            
            // MAGIåˆ†æã‚’ç°¡æ˜“è¡¨ç¤º
            const todayTotal = revenueData
                .filter(r => r.date === date)
                .reduce((sum, r) => sum + r.amount, 0);
            
            const monthlyWorkDays = workScheduleCalc.calculateTotalWorkDays(new Date().getFullYear(), new Date().getMonth());
            const dailyTarget = Math.round(currentMonthlyTarget / monthlyWorkDays);
            const achievementRate = Math.round((todayTotal / dailyTarget) * 100);
            
            let message = '';
            if (achievementRate >= 100) {
                message = 'ğŸ‰ ç›®æ¨™é”æˆï¼ç´ æ™´ã‚‰ã—ã„ï¼';
            } else if (achievementRate >= 80) {
                message = 'ğŸ‘ å¥½èª¿ï¼ã‚ã¨å°‘ã—ï¼';
            } else if (achievementRate >= 50) {
                message = 'ğŸ’ª é ‘å¼µã£ã¦ï¼ã¾ã é–“ã«åˆã†ï¼';
            } else {
                message = 'ğŸš€ ãƒ“ãƒƒã‚°ã‚²ãƒ¼ãƒ ã‚’ç‹™ãˆï¼';
            }
            
            // ä¸€ç¬ã ã‘æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const originalText = document.querySelector('#revenueForm button').textContent;
            document.querySelector('#revenueForm button').textContent = message;
            setTimeout(() => {
                document.querySelector('#revenueForm button').textContent = originalText;
            }, 1500);
        });

        // ç›´æ¥å£²ä¸Šå…¥åŠ›
        function saveDirectInput() {
            const dateInput = document.getElementById('directDate').value;
            const amount = parseInt(document.getElementById('directAmount').value);
            
            if (!dateInput || !amount || amount <= 0) {
                alert('æ—¥ä»˜ã¨é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const date = new Date(dateInput);
            const dateStr = date.toLocaleDateString('ja-JP');
            const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
            
            // ãã®æ—¥ã®æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
            revenueData = revenueData.filter(record => record.date !== dateStr);
            
            // æ–°ã—ã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ï¼ˆ1æ—¥ã®ç·å£²ä¸Šã¨ã—ã¦ï¼‰
            const record = {
                id: Date.now(),
                date: dateStr,
                time: '23:59',
                amount: amount,
                memo: 'ç›´æ¥å…¥åŠ›',
                dayOfWeek: dayOfWeek,
                isLongCustomer: false,
                timestamp: new Date().toISOString()
            };
            
            revenueData.push(record);
            localStorage.setItem('taxiRevenue', JSON.stringify(revenueData));
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('directAmount').value = '';
            
            // å…¨è¡¨ç¤ºã‚’å³åº§ã«æ›´æ–°
            updateAllDisplay();
            updateChart();
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            document.getElementById('directInputInfo').innerHTML = `
                <span class="text-green-600 dark:text-green-400">âœ… ${dateStr}ã®å£²ä¸Šã‚’Â¥${amount.toLocaleString()}ã§ä¿å­˜ã—ã¾ã—ãŸ</span>
            `;
            setTimeout(() => {
                document.getElementById('directInputInfo').innerHTML = '';
            }, 3000);
        }

        // ãƒ­ãƒ³ã‚°å®¢ãƒªã‚¹ãƒˆæ›´æ–°
        function updateLongCustomerList() {
            const container = document.getElementById('longCustomerList');
            const today = new Date().toLocaleDateString('ja-JP');
            
            // ä»Šæ—¥ã®ãƒ­ãƒ³ã‚°å®¢ã‚’å–å¾—
            const todayLongCustomers = longCustomerData.filter(record => record.date === today);
            
            if (todayLongCustomers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">æœ¬æ—¥ã®ãƒ­ãƒ³ã‚°å®¢è¨˜éŒ²ãªã—</p>';
                return;
            }
            
            container.innerHTML = todayLongCustomers
                .sort((a, b) => a.time.localeCompare(b.time))
                .map(record => `
                    <div class="flex justify-between items-center p-2 bg-purple-50 dark:bg-purple-900 rounded-lg">
                        <div>
                            <span class="font-medium">${record.time}</span>
                            <span class="text-purple-600 dark:text-purple-300 ml-2">Â¥${record.amount.toLocaleString()}</span>
                            ${record.memo ? `<span class="text-gray-600 dark:text-gray-400 ml-2 text-xs">${record.memo}</span>` : ''}
                        </div>
                        <span class="text-xs text-purple-500 dark:text-purple-400">ãƒ­ãƒ³ã‚°å®¢</span>
                    </div>
                `).join('');
        }

        // é€±é–“ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateChart() {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            const last7Days = [];
            const dailyRevenue = [];
            const dailyTargets = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('ja-JP');
                const dayName = date.toLocaleDateString('ja-JP', { weekday: 'short' });
                
                last7Days.push(dayName);
                
                const dayRevenue = revenueData
                    .filter(record => record.date === dateStr)
                    .reduce((sum, record) => sum + record.amount, 0);
                
                dailyRevenue.push(dayRevenue);
                
                // ç›®æ¨™ã‚‚è¨ˆç®—
                const monthlyWorkDays = workScheduleCalc.calculateTotalWorkDays(date.getFullYear(), date.getMonth());
                const dailyTarget = Math.round(currentMonthlyTarget / monthlyWorkDays);
                dailyTargets.push(dailyTarget);
            }
            
            if (weeklyChart) {
                weeklyChart.destroy();
            }
            
            weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'æ—¥æ¬¡å£²ä¸Š',
                        data: dailyRevenue,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'ç›®æ¨™å£²ä¸Š',
                        data: dailyTargets,
                        borderColor: 'rgb(239, 68, 68)',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: html.classList.contains('dark') ? '#e0e0e0' : '#374151',
                                font: { size: 11 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: html.classList.contains('dark') ? '#e0e0e0' : '#374151',
                                font: { size: 10 },
                                callback: function(value) {
                                    return 'Â¥' + (value / 1000) + 'k';
                                }
                            },
                            grid: {
                                color: html.classList.contains('dark') ? '#404040' : '#e5e7eb'
                            }
                        },
                        x: {
                            ticks: {
                                color: html.classList.contains('dark') ? '#e0e0e0' : '#374151',
                                font: { size: 10 }
                            },
                            grid: {
                                color: html.classList.contains('dark') ? '#404040' : '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const exportData = {
                revenueData: revenueData,
                longCustomerData: longCustomerData,
                monthlyTarget: currentMonthlyTarget,
                baseDate: workScheduleCalc.baseDate.toISOString(),
                baseWorkDay: workScheduleCalc.baseWorkDay,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `taxi-weekend-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('taxiRevenue');
                localStorage.removeItem('longCustomerData');
                localStorage.removeItem('monthlyTarget');
                localStorage.removeItem('manualBaseDate');
                localStorage.removeItem('manualBaseWorkDay');
                revenueData = [];
                longCustomerData = [];
                updateAllDisplay();
                updateChart();
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }
    </script>
</body>
</html>
