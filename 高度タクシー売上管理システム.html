
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAGIã‚¿ã‚¯ã‚·ãƒ¼å£²ä¸Šç®¡ç† - ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®š
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#1a1a1a',
                        'dark-card': '#2d2d2d',
                        'dark-text': '#e0e0e0',
                        'dark-border': '#404040'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-dark-bg text-gray-900 dark:text-dark-text transition-colors duration-300">
    <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
    <div class="fixed top-4 right-4 z-50">
        <button id="darkModeToggle" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            <span class="text-xl">ğŸŒ™</span>
        </button>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800 dark:text-dark-text">ğŸš• MAGIã‚¿ã‚¯ã‚·ãƒ¼å£²ä¸Šç®¡ç†</h1>
        
        <!-- æœˆé–“æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 mb-6 border border-gray-200 dark:border-dark-border">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-dark-text">ğŸ“… <span id="currentMonth">2026å¹´2æœˆ</span> å–¶æ¥­æƒ…å ±</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-300">æœˆé–“å–¶æ¥­æ—¥æ•°</p>
                    <p class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="monthlyWorkDays">0æ—¥</p>
                </div>
                <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-300">æœ¬æ—¥ã®å‡ºå‹¤</p>
                    <p class="text-2xl font-bold text-green-600 dark:text-green-400" id="todayWorkDay">0æ—¥ç›®</p>
                </div>
                <div class="bg-orange-50 dark:bg-orange-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-300">æ®‹ã‚Šå–¶æ¥­æ—¥æ•°</p>
                    <p class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="remainingWorkDays">0æ—¥</p>
                </div>
                <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-300">1æ—¥ç›®æ¨™é‡‘é¡</p>
                    <p class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="dailyTarget">Â¥0</p>
                </div>
            </div>
            
            <!-- æœˆé–“ç›®æ¨™é¸æŠ -->
            <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                <h3 class="font-semibold mb-3 text-gray-700 dark:text-dark-text">æœˆé–“ç›®æ¨™é¸æŠ</h3>
                <div class="grid grid-cols-3 gap-4">
                    <button onclick="setMonthlyTarget(600000)" class="monthly-target-btn p-3 rounded-lg bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors border-2 border-blue-300 dark:border-blue-600" data-target="600000">
                        <div class="text-lg font-bold text-blue-700 dark:text-blue-300">60ä¸‡å††</div>
                        <div class="text-sm text-blue-600 dark:text-blue-400" id="target60k">1æ—¥ Â¥0</div>
                    </button>
                    <button onclick="setMonthlyTarget(700000)" class="monthly-target-btn p-3 rounded-lg bg-green-100 dark:bg-green-900 hover:bg-green-200 dark:hover:bg-green-800 transition-colors border-2 border-green-300 dark:border-green-600" data-target="700000">
                        <div class="text-lg font-bold text-green-700 dark:text-green-300">70ä¸‡å††</div>
                        <div class="text-sm text-green-600 dark:text-green-400" id="target70k">1æ—¥ Â¥0</div>
                    </button>
                    <button onclick="setMonthlyTarget(800000)" class="monthly-target-btn p-3 rounded-lg bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors border-2 border-purple-300 dark:border-purple-600" data-target="800000">
                        <div class="text-lg font-bold text-purple-700 dark:text-purple-300">80ä¸‡å††</div>
                        <div class="text-sm text-purple-600 dark:text-purple-400" id="target80k">1æ—¥ Â¥0</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- ä»Šæ—¥ã®çŠ¶æ³ã‚«ãƒ¼ãƒ‰ -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 mb-6 border border-gray-200 dark:border-dark-border">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-dark-text">ğŸ“Š ä»Šæ—¥ã®çŠ¶æ³</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-300">ç›®æ¨™å£²ä¸Š</p>
                    <p class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="targetAmount">Â¥0</p>
                </div>
                <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-300">ç¾åœ¨ã®å£²ä¸Š</p>
                    <p class="text-2xl font-bold text-green-600 dark:text-green-400" id="currentRevenue">Â¥0</p>
                </div>
                <div class="bg-orange-50 dark:bg-orange-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-300">é”æˆç‡</p>
                    <p class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="achievementRate">0%</p>
                </div>
                <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-300">ãƒ­ãƒ³ã‚°å®¢æ•°</p>
                    <p class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="longCustomerCount">0ä»¶</p>
                </div>
            </div>
        </div>

        <!-- å£²ä¸Šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 mb-6 border border-gray-200 dark:border-dark-border">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-dark-text">ğŸ’° å£²ä¸Šã‚’è¨˜éŒ²</h2>
            <form id="revenueForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ™‚é–“</label>
                        <input type="time" id="time" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-dark-text">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å£²ä¸Šé‡‘é¡</label>
                        <input type="number" id="amount" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-dark-text" placeholder="ä¾‹: 2500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ›œæ—¥</label>
                        <select id="dayOfWeek" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-dark-text">
                            <option value="æœˆ">æœˆæ›œæ—¥</option>
                            <option value="ç«">ç«æ›œæ—¥</option>
                            <option value="æ°´">æ°´æ›œæ—¥</option>
                            <option value="æœ¨">æœ¨æ›œæ—¥</option>
                            <option value="é‡‘">é‡‘æ›œæ—¥</option>
                            <option value="åœŸ">åœŸæ›œæ—¥</option>
                            <option value="æ—¥">æ—¥æ›œæ—¥</option>
                        </select>
                    </div>
                </div>
                
                <!-- ãƒ­ãƒ³ã‚°å®¢ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
                <div class="flex items-center">
                    <input type="checkbox" id="isLongCustomer" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="isLongCustomer" class="text-sm font-medium text-gray-700 dark:text-gray-300">ãƒ­ãƒ³ã‚°å®¢ï¼ˆé•·è·é›¢ä¹—å®¢ï¼‰</label>
                </div>

                <!-- ãƒ­ãƒ³ã‚°å®¢è©³ç´°ï¼ˆæ¡ä»¶ä»˜ãè¡¨ç¤ºï¼‰ -->
                <div id="longCustomerDetails" class="hidden space-y-4 p-4 bg-purple-50 dark:bg-purple-900 rounded-lg">
                    <h3 class="font-medium text-purple-800 dark:text-purple-300">ãƒ­ãƒ³ã‚°å®¢æƒ…å ±</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ä¹—è»Šå ´æ‰€</label>
                            <input type="text" id="pickupLocation" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-dark-text" placeholder="ä¾‹: é§…å‰ã€ç©ºæ¸¯ã€ãƒ›ãƒ†ãƒ«">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">é™è»Šå ´æ‰€</label>
                            <input type="text" id="dropoffLocation" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-dark-text" placeholder="ä¾‹: å¸‚å†…ã€éš£ç”ºã€è¦³å…‰åœ°">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å®¢å±¤ãƒ»ç‰¹å¾´</label>
                        <input type="text" id="customerType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-dark-text" placeholder="ä¾‹: ãƒ“ã‚¸ãƒã‚¹ãƒãƒ³ã€è¦³å…‰å®¢ã€å®¶æ—é€£ã‚Œ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">è·é›¢ï¼ˆkmï¼‰</label>
                        <input type="number" id="distance" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-dark-text" placeholder="ä¾‹: 25">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                    <input type="text" id="memo" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-dark-text" placeholder="ä¾‹: ç©ºæ¸¯é€è¿ã€è¦³å…‰å®¢ãªã©">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                    å£²ä¸Šã‚’è¨˜éŒ²ã—ã¦MAGIåˆ†æã‚’å—ã‘ã‚‹
                </button>
            </form>
        </div>

        <!-- MAGIåˆ†æçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="magiAnalysis" class="hidden bg-white dark:bg-dark-card rounded-lg shadow-md p-6 mb-6 border border-gray-200 dark:border-dark-border">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-dark-text">ğŸ§  MAGIåˆ†æçµæœ</h2>
            <div id="magiResults" class="space-y-4 text-sm"></div>
        </div>

        <!-- ãƒ­ãƒ³ã‚°å®¢è¨˜éŒ²ä¸€è¦§ -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 mb-6 border border-gray-200 dark:border-dark-border">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-dark-text">ğŸ¯ ãƒ­ãƒ³ã‚°å®¢è¨˜éŒ²</h2>
            <div id="longCustomerList" class="space-y-2">
                <p class="text-gray-500 dark:text-gray-400 text-center py-4">ãƒ­ãƒ³ã‚°å®¢ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>

        <!-- å£²ä¸Šä¸€è¦§ -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 mb-6 border border-gray-200 dark:border-dark-border">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-dark-text">ä»Šæ—¥ã®å£²ä¸Šä¸€è¦§</h2>
            <div id="revenueList" class="space-y-2">
                <p class="text-gray-500 dark:text-gray-400 text-center py-4">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>

        <!-- é€±é–“ã‚°ãƒ©ãƒ• -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 mb-6 border border-gray-200 dark:border-dark-border">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-dark-text">é€±é–“å£²ä¸Šæ¨ç§»</h2>
            <canvas id="weeklyChart" width="400" height="200"></canvas>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒœã‚¿ãƒ³ -->
        <div class="flex gap-4 justify-center">
            <button onclick="exportData()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-md transition duration-200">
                ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            <button onclick="clearData()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md transition duration-200">
                ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            </button>
        </div>
    </div>

    <script>
        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
        const darkModeToggle = document.getElementById('darkModeToggle');
        const html = document.documentElement;

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
        if (localStorage.getItem('darkMode') === 'true' || 
            (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
            darkModeToggle.innerHTML = 'â˜€ï¸';
        }

        darkModeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            darkModeToggle.innerHTML = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        });

        // 4å‹¤å‹™2ä¼‘ã¿è¨ˆç®—ã‚¯ãƒ©ã‚¹
        class WorkScheduleCalculator {
            constructor() {
                this.workPattern = [true, true, true, true, false, false]; // 4å‹¤å‹™2ä¼‘ã¿
                this.referenceDate = new Date(2026, 1, 1); // 2026å¹´2æœˆ1æ—¥
                this.referenceWorkDay = 3; // 3å‹¤å‹™ç›®
            }

            // æŒ‡å®šå¹´æœˆã®å–¶æ¥­æ—¥æ•°ã‚’è¨ˆç®—
            calculateMonthlyWorkDays(year, month) {
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                // åŸºæº–æ—¥ã‹ã‚‰ã®æ—¥æ•°å·®ã‚’è¨ˆç®—
                const diffTime = firstDay - this.referenceDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                // åŸºæº–æ—¥ã®å‹¤å‹™æ—¥ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ±‚ã‚ã‚‹
                let currentIndex = (this.referenceWorkDay - 1 + diffDays) % 6;
                if (currentIndex < 0) currentIndex += 6;
                
                let workDays = 0;
                let currentDate = new Date(firstDay);
                
                while (currentDate <= lastDay) {
                    if (this.workPattern[currentIndex]) {
                        workDays++;
                    }
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                    currentIndex = (currentIndex + 1) % 6;
                }
                
                return workDays;
            }

            // æŒ‡å®šæ—¥ãŒãã®æœˆã®ä½•æ—¥ç›®ã®å‡ºå‹¤æ—¥ã‹
            getWorkDayIndex(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                
                // åŸºæº–æ—¥ã‹ã‚‰ã®æ—¥æ•°å·®ã‚’è¨ˆç®—
                const diffTime = date - this.referenceDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                // åŸºæº–æ—¥ã®å‹¤å‹™æ—¥ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ±‚ã‚ã‚‹
                let currentIndex = (this.referenceWorkDay - 1 + diffDays) % 6;
                if (currentIndex < 0) currentIndex += 6;
                
                // æœˆåˆã‹ã‚‰ã®å‹¤å‹™æ—¥æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                let workDayIndex = 0;
                let currentDate = new Date(firstDay);
                
                while (currentDate <= date) {
                    if (this.workPattern[currentIndex]) {
                        workDayIndex++;
                    }
                    
                    if (currentDate.getTime() === date.getTime()) {
                        break;
                    }
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                    currentIndex = (currentIndex + 1) % 6;
                }
                
                return workDayIndex;
            }

            // æ®‹ã‚Šã®å–¶æ¥­æ—¥æ•°ã‚’è¨ˆç®—
            getRemainingWorkDays(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const totalWorkDays = this.calculateMonthlyWorkDays(year, month);
                const currentWorkDay = this.getWorkDayIndex(date);
                return totalWorkDays - currentWorkDay;
            }

            // ä»Šæ—¥ãŒå‹¤å‹™æ—¥ã‹ã©ã†ã‹
            isWorkDay(date) {
                const diffTime = date - this.referenceDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const currentIndex = (this.referenceWorkDay - 1 + diffDays) % 6;
                return this.workPattern[currentIndex >= 0 ? currentIndex : currentIndex + 6];
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        const workScheduleCalc = new WorkScheduleCalculator();
        let revenueData = JSON.parse(localStorage.getItem('taxiRevenue')) || [];
        let longCustomerData = JSON.parse(localStorage.getItem('longCustomerData')) || [];
        let currentMonthlyTarget = parseInt(localStorage.getItem('monthlyTarget')) || 600000;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateMonthlyInfo();
            updateDisplay();
            updateChart();
            
            // ç¾åœ¨æ™‚åˆ»ã‚’è¨­å®š
            const now = new Date();
            document.getElementById('time').value = now.toTimeString().slice(0, 5);
            
            // æ›œæ—¥ã‚’è¨­å®š
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            document.getElementById('dayOfWeek').value = days[now.getDay()];
            
            // æœˆé–“ç›®æ¨™ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelector(`[data-target="${currentMonthlyTarget}"]`)?.classList.add('ring-2', 'ring-blue-500');
        });

        // æœˆé–“æƒ…å ±æ›´æ–°
        function updateMonthlyInfo() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // æœˆè¡¨ç¤ºæ›´æ–°
            document.getElementById('currentMonth').textContent = `${year}å¹´${month + 1}æœˆ`;
            
            // å–¶æ¥­æ—¥æ•°è¨ˆç®—
            const monthlyWorkDays = workScheduleCalc.calculateMonthlyWorkDays(year, month);
            const todayWorkDay = workScheduleCalc.getWorkDayIndex(now);
            const remainingWorkDays = workScheduleCalc.getRemainingWorkDays(now);
            
            // è¡¨ç¤ºæ›´æ–°
            document.getElementById('monthlyWorkDays').textContent = `${monthlyWorkDays}æ—¥`;
            document.getElementById('todayWorkDay').textContent = `${todayWorkDay}æ—¥ç›®`;
            document.getElementById('remainingWorkDays').textContent = `${remainingWorkDays}æ—¥`;
            
            // 1æ—¥ç›®æ¨™é‡‘é¡è¨ˆç®—ã¨è¡¨ç¤º
            updateDailyTargets(monthlyWorkDays);
            
            // ä»Šæ—¥ã®ç›®æ¨™é‡‘é¡æ›´æ–°
            const dailyTarget = Math.round(currentMonthlyTarget / monthlyWorkDays);
            document.getElementById('targetAmount').textContent = `Â¥${dailyTarget.toLocaleString()}`;
            
            // å‹¤å‹™æ—¥ã§ãªã„å ´åˆã®è­¦å‘Š
            if (!workScheduleCalc.isWorkDay(now)) {
                document.getElementById('todayWorkDay').innerHTML = '<span class="text-red-500">æœ¬æ—¥ã¯ä¼‘æ—¥</span>';
            }
        }

        // 1æ—¥ç›®æ¨™é‡‘é¡æ›´æ–°
        function updateDailyTargets(monthlyWorkDays) {
            const targets = [600000, 700000, 800000];
            const targetIds = ['target60k', 'target70k', 'target80k'];
            
            targets.forEach((target, index) => {
                const dailyTarget = Math.round(target / monthlyWorkDays);
                document.getElementById(targetIds[index]).textContent = `1æ—¥ Â¥${dailyTarget.toLocaleString()}`;
            });
        }

        // æœˆé–“ç›®æ¨™è¨­å®š
        function setMonthlyTarget(target) {
            currentMonthlyTarget = target;
            localStorage.setItem('monthlyTarget', target);
            
            // ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
            document.querySelectorAll('.monthly-target-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-500');
            });
            document.querySelector(`[data-target="${target}"]`)?.classList.add('ring-2', 'ring-blue-500');
            
            updateMonthlyInfo();
            updateDisplay();
        }

        // ãƒ­ãƒ³ã‚°å®¢ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('isLongCustomer').addEventListener('change', function() {
            const details = document.getElementById('longCustomerDetails');
            if (this.checked) {
                details.classList.remove('hidden');
            } else {
                details.classList.add('hidden');
            }
        });

        // MAGIåˆ†æé–¢æ•°ï¼ˆä»¥å‰ã¨åŒã˜ï¼‰
        function performMAGiAnalysis(revenueRecord, todayTotal, target, longCustomers) {
            const achievementRate = (todayTotal / target) * 100;
            const currentTime = revenueRecord.time;
            const dayOfWeek = revenueRecord.dayOfWeek;
            
            let analysis = {
                logic: `ç¾åœ¨æ™‚åˆ»${currentTime}ã§${achievementRate.toFixed(1)}%é”æˆã€‚`,
                moral: "å®‰å…¨é‹è»¢ã‚’æœ€å„ªå…ˆã«ã€‚",
                desire: longCustomers.length > 0 ? "ãƒ­ãƒ³ã‚°å®¢ç²å¾—ã®æ‰‹å¿œãˆã‚ã‚Šã€‚" : "ãƒ“ãƒƒã‚°ã‚²ãƒ¼ãƒ ã‚’ç‹™ãˆã€‚",
                future: "ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã¯æ¥é€±ã®åŒã˜æ›œæ—¥ã®å‚è€ƒã«ãªã‚‹ã€‚",
                critic: "åŠ¹ç‡ï¼ˆå††/æ™‚é–“ï¼‰ã‚‚æ¸¬å®šã™ã¹ãã€‚",
                create: "æ–°è¦é¡§å®¢å±¤é–‹æ‹“ã‚’ææ¡ˆã€‚",
                empathy: "å¸¸é€£å®¢ã¨ã®é–¢ä¿‚æ€§æ§‹ç¯‰ãŒé‡è¦ã€‚",
                realist: "ç¾åœ¨åœ°ã‹ã‚‰æœ€å¯„ã‚Šã®é«˜éœ€è¦ã‚¨ãƒªã‚¢ã‚’ç¢ºèªã€‚",
                care: "ä»Šæ—¥ã®åŠªåŠ›ã‚’è©•ä¾¡ã€‚",
                rebel: "ä»–ã®ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãŒé¿ã‘ã‚‹æ™‚é–“å¸¯ã«ãƒãƒ£ãƒ³ã‚¹ã‚ã‚Šã€‚",
                meta: "æ•°å€¤ç›®æ¨™ã¨é¡§å®¢æº€è¶³åº¦ã€å®‰å…¨é‹è»¢ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®ã€‚",
                conclusion: ""
            };

            // åˆ¤å®šçµæœ
            let approval = [];
            let opposition = [];
            let conditional = [];

            if (achievementRate >= 80) {
                approval = ["LOGIC", "DESIRE", "FUTURE"];
                conditional = ["MORAL", "REALIST"];
            } else if (achievementRate >= 50) {
                approval = ["CREATE", "EMPATHY", "REBEL"];
                conditional = ["LOGIC", "REALIST"];
            } else {
                approval = ["CREATE", "REBEL"];
                conditional = ["LOGIC", "FUTURE", "REALIST"];
            }

            return {
                results: analysis,
                decision: {
                    approval: approval,
                    opposition: opposition,
                    conditional: conditional,
                    result: achievementRate >= 100 ? "æ‰¿èª" : achievementRate >= 50 ? "æ¡ä»¶ä»˜ãæ‰¿èª" : "å†å¯©è­°è¦æ±‚",
                    summary: achievementRate >= 100 ? "ç›®æ¨™é”æˆã€‚è¿½åŠ åå…¥ã‚’ç‹™ãˆã€‚" : "æˆ¦ç•¥çš„ãªå–¶æ¥­ç¶™ç¶šã‚’ã€‚"
                }
            };
        }

        // å£²ä¸Šè¨˜éŒ²
        document.getElementById('revenueForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const time = document.getElementById('time').value;
            const amount = parseInt(document.getElementById('amount').value);
            const memo = document.getElementById('memo').value;
            const dayOfWeek = document.getElementById('dayOfWeek').value;
            const date = new Date().toLocaleDateString('ja-JP');
            const isLongCustomer = document.getElementById('isLongCustomer').checked;
            
            const record = {
                id: Date.now(),
                date: date,
                time: time,
                amount: amount,
                memo: memo,
                dayOfWeek: dayOfWeek,
                isLongCustomer: isLongCustomer,
                timestamp: new Date().toISOString()
            };
            
            revenueData.push(record);
            localStorage.setItem('taxiRevenue', JSON.stringify(revenueData));
            
            // ãƒ­ãƒ³ã‚°å®¢ã®å ´åˆã€è©³ç´°æƒ…å ±ã‚‚ä¿å­˜
            if (isLongCustomer) {
                const longCustomerRecord = {
                    id: record.id,
                    date: date,
                    time: time,
                    dayOfWeek: dayOfWeek,
                    amount: amount,
                    pickupLocation: document.getElementById('pickupLocation').value,
                    dropoffLocation: document.getElementById('dropoffLocation').value,
                    customerType: document.getElementById('customerType').value,
                    distance: parseInt(document.getElementById('distance').value) || 0,
                    memo: memo
                };
                longCustomerData.push(longCustomerRecord);
                localStorage.setItem('longCustomerData', JSON.stringify(longCustomerData));
            }
            
            // MAGIåˆ†æå®Ÿè¡Œ
            const todayTotal = revenueData
                .filter(r => r.date === date)
                .reduce((sum, r) => sum + r.amount, 0);
            
            const todayLongCustomers = longCustomerData
                .filter(r => r.date === date);
            
            const dailyTarget = Math.round(currentMonthlyTarget / workScheduleCalc.calculateMonthlyWorkDays(new Date().getFullYear(), new Date().getMonth()));
            const magiAnalysis = performMAGiAnalysis(record, todayTotal, dailyTarget, todayLongCustomers);
            displayMAGiResults(magiAnalysis);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            this.reset();
            document.getElementById('longCustomerDetails').classList.add('hidden');
            document.getElementById('isLongCustomer').checked = false;
            
            // ç¾åœ¨æ™‚åˆ»ã‚’å†è¨­å®š
            const now = new Date();
            document.getElementById('time').value = now.toTimeString().slice(0, 5);
            
            // è¡¨ç¤ºæ›´æ–°
            updateDisplay();
            updateChart();
        });

        // MAGIçµæœè¡¨ç¤º
        function displayMAGiResults(analysis) {
            const resultsDiv = document.getElementById('magiResults');
            const analysisDiv = document.getElementById('magiAnalysis');
            
            resultsDiv.innerHTML = `
                <div class="space-y-3">
                    <div class="p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                        <span class="font-semibold text-blue-700 dark:text-blue-300">ğŸ”µ MAGI-1 (LOGIC):</span>
                        <span class="ml-2">${analysis.results.logic}</span>
                    </div>
                    <div class="p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg">
                        <span class="font-semibold text-yellow-700 dark:text-yellow-300">ğŸŸ¡ MAGI-2 (MORAL):</span>
                        <span class="ml-2">${analysis.results.moral}</span>
                    </div>
                    <div class="p-3 bg-red-50 dark:bg-red-900 rounded-lg">
                        <span class="font-semibold text-red-700 dark:text-red-300">ğŸ”´ MAGI-3 (DESIRE):</span>
                        <span class="ml-2">${analysis.results.desire}</span>
                    </div>
                    <div class="p-3 bg-purple-50 dark:bg-purple-900 rounded-lg">
                        <span class="font-semibold text-purple-700 dark:text-purple-300">ğŸŸ£ MAGI-4 (FUTURE):</span>
                        <span class="ml-2">${analysis.results.future}</span>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="font-semibold text-gray-700 dark:text-gray-300">âš« MAGI-5 (CRITIC):</span>
                        <span class="ml-2">${analysis.results.critic}</span>
                    </div>
                    <div class="p-3 bg-green-50 dark:bg-green-900 rounded-lg">
                        <span class="font-semibold text-green-700 dark:text-green-300">ğŸŸ¢ MAGI-6 (CREATE):</span>
                        <span class="ml-2">${analysis.results.create}</span>
                    </div>
                    <div class="p-3 bg-cyan-50 dark:bg-cyan-900 rounded-lg">
                        <span class="font-semibold text-cyan-700 dark:text-cyan-300">ğŸ©µ MAGI-7 (EMPATHY):</span>
                        <span class="ml-2">${analysis.results.empathy}</span>
                    </div>
                    <div class="p-3 bg-amber-50 dark:bg-amber-900 rounded-lg">
                        <span class="font-semibold text-amber-700 dark:text-amber-300">ğŸŸ¤ MAGI-8 (REALIST):</span>
                        <span class="ml-2">${analysis.results.realist}</span>
                    </div>
                    <div class="p-3 bg-pink-50 dark:bg-pink-900 rounded-lg">
                        <span class="font-semibold text-pink-700 dark:text-pink-300">ğŸ©· MAGI-9 (CARE):</span>
                        <span class="ml-2">${analysis.results.care}</span>
                    </div>
                    <div class="p-3 bg-white dark:bg-gray-600 border rounded-lg">
                        <span class="font-semibold text-gray-700 dark:text-gray-300">âšª MAGI-10 (REBEL):</span>
                        <span class="ml-2">${analysis.results.rebel}</span>
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-indigo-50 dark:bg-indigo-900 rounded-lg border-2 border-indigo-200 dark:border-indigo-600">
                    <span class="font-semibold text-indigo-700 dark:text-indigo-300">ğŸª MAGI-11 (META) ä¿¯ç°æ‰€è¦‹:</span>
                    <span class="ml-2">${analysis.results.meta}</span>
                </div>
                
                <div class="mt-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <h4 class="font-bold text-gray-800 dark:text-gray-200 mb-2">ã€åˆ¤å®šçµæœã€‘</h4>
                    <p><span class="font-semibold">è³›æˆ:</span> ${analysis.decision.approval.join(', ')}</p>
                    <p><span class="font-semibold">åå¯¾:</span> ${analysis.decision.opposition.join(', ')}</p>
                    <p><span class="font-semibold">æ¡ä»¶ä»˜ã:</span> ${analysis.decision.conditional.join(', ')}</p>
                    
                    <h4 class="font-bold text-gray-800 dark:text-gray-200 mt-3 mb-2">ã€æœ€çµ‚æ±ºè­°ã€‘</h4>
                    <p><span class="font-semibold">çµæœ:</span> ${analysis.decision.result}</p>
                    <p><span class="font-semibold">ç·è©•:</span> ${analysis.decision.summary}</p>
                </div>
            `;
            
            analysisDiv.classList.remove('hidden');
        }

        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            const today = new Date().toLocaleDateString('ja-JP');
            const todayRevenue = revenueData
                .filter(record => record.date === today)
                .reduce((sum, record) => sum + record.amount, 0);
            
            const todayLongCustomers = longCustomerData
                .filter(record => record.date === today);
            
            const monthlyWorkDays = workScheduleCalc.calculateMonthlyWorkDays(new Date().getFullYear(), new Date().getMonth());
            const dailyTarget = Math.round(currentMonthlyTarget / monthlyWorkDays);
            
            document.getElementById('targetAmount').textContent = `Â¥${dailyTarget.toLocaleString()}`;
            document.getElementById('currentRevenue').textContent = `Â¥${todayRevenue.toLocaleString()}`;
            document.getElementById('longCustomerCount').textContent = `${todayLongCustomers.length}ä»¶`;
            
            const achievementRate = Math.round((todayRevenue / dailyTarget) * 100);
            document.getElementById('achievementRate').textContent = `${achievementRate}%`;
            
            // å£²ä¸Šä¸€è¦§æ›´æ–°
            updateRevenueList();
            // ãƒ­ãƒ³ã‚°å®¢ä¸€è¦§æ›´æ–°
            updateLongCustomerList();
        }

        // å£²ä¸Šä¸€è¦§æ›´æ–°
        function updateRevenueList() {
            const today = new Date().toLocaleDateString('ja-JP');
            const todayRecords = revenueData.filter(record => record.date === today);
            
            const listContainer = document.getElementById('revenueList');
            
            if (todayRecords.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            listContainer.innerHTML = todayRecords
                .sort((a, b) => a.time.localeCompare(b.time))
                .map(record => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg ${record.isLongCustomer ? 'border-l-4 border-purple-500' : ''}">
                        <div>
                            <span class="font-medium">${record.time}</span>
                            <span class="text-gray-600 dark:text-gray-400 ml-2">(${record.dayOfWeek})</span>
                            ${record.memo ? `<span class="text-gray-600 dark:text-gray-400 ml-2">- ${record.memo}</span>` : ''}
                            ${record.isLongCustomer ? '<span class="ml-2 px-2 py-1 bg-purple-100 dark:bg-purple-800 text-purple-700 dark:text-purple-300 text-xs rounded">ãƒ­ãƒ³ã‚°å®¢</span>' : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-green-600 dark:text-green-400">Â¥${record.amount.toLocaleString()}</span>
                            <button onclick="deleteRecord(${record.id})" class="text-red-500 hover:text-red-700 dark:text-red-400 text-sm">å‰Šé™¤</button>
                        </div>
                    </div>
                `).join('');
        }

        // ãƒ­ãƒ³ã‚°å®¢ä¸€è¦§æ›´æ–°
        function updateLongCustomerList() {
            const listContainer = document.getElementById('longCustomerList');
            
            if (longCustomerData.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">ãƒ­ãƒ³ã‚°å®¢ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // ç›´è¿‘ã®10ä»¶ã‚’è¡¨ç¤º
            const recentLongCustomers = longCustomerData
                .sort((a, b) => new Date(b.timestamp || b.date + ' ' + b.time) - new Date(a.timestamp || a.date + ' ' + a.time))
                .slice(0, 10);
            
            listContainer.innerHTML = recentLongCustomers
                .map(record => `
                    <div class="p-3 bg-purple-50 dark:bg-purple-900 rounded-lg border border-purple-200 dark:border-purple-700">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-medium">${record.date} ${record.time}</span>
                                <span class="text-purple-600 dark:text-purple-300 ml-2">(${record.dayOfWeek})</span>
                            </div>
                            <span class="font-bold text-purple-700 dark:text-purple-300">Â¥${record.amount.toLocaleString()}</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                            <p><span class="font-medium">çµŒè·¯:</span> ${record.pickupLocation} â†’ ${record.dropoffLocation}</p>
                            <p><span class="font-medium">è·é›¢:</span> ${record.distance}km</p>
                            <p><span class="font-medium">å®¢å±¤:</span> ${record.customerType}</p>
                            ${record.memo ? `<p><span class="font-medium">ãƒ¡ãƒ¢:</span> ${record.memo}</p>` : ''}
                        </div>
                    </div>
                `).join('');
        }

        // ãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤
        function deleteRecord(id) {
            if (confirm('ã“ã®å£²ä¸Šè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                revenueData = revenueData.filter(record => record.id !== id);
                longCustomerData = longCustomerData.filter(record => record.id !== id);
                localStorage.setItem('taxiRevenue', JSON.stringify(revenueData));
                localStorage.setItem('longCustomerData', JSON.stringify(longCustomerData));
                updateDisplay();
                updateChart();
            }
        }

        // é€±é–“ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateChart() {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            // éå»7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const last7Days = [];
            const dailyRevenue = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('ja-JP');
                const dayName = date.toLocaleDateString('ja-JP', { weekday: 'short' });
                
                last7Days.push(dayName);
                
                const dayRevenue = revenueData
                    .filter(record => record.date === dateStr)
                    .reduce((sum, record) => sum + record.amount, 0);
                
                dailyRevenue.push(dayRevenue);
            }
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (window.weeklyChart) {
                window.weeklyChart.destroy();
            }
            
            const monthlyWorkDays = workScheduleCalc.calculateMonthlyWorkDays(new Date().getFullYear(), new Date().getMonth());
            const dailyTarget = Math.round(currentMonthlyTarget / monthlyWorkDays);
            
            window.weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'æ—¥æ¬¡å£²ä¸Š',
                        data: dailyRevenue,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'ç›®æ¨™å£²ä¸Š',
                        data: Array(7).fill(dailyTarget),
                        borderColor: 'rgb(239, 68, 68)',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: html.classList.contains('dark') ? '#e0e0e0' : '#374151'
                            }
                        },
                        title: {
                            display: true,
                            text: 'é€±é–“å£²ä¸Šæ¨ç§»',
                            color: html.classList.contains('dark') ? '#e0e0e0' : '#374151'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: html.classList.contains('dark') ? '#e0e0e0' : '#374151',
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: html.classList.contains('dark') ? '#404040' : '#e5e7eb'
                            }
                        },
                        x: {
                            ticks: {
                                color: html.classList.contains('dark') ? '#e0e0e0' : '#374151'
                            },
                            grid: {
                                color: html.classList.contains('dark') ? '#404040' : '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const exportData = {
                revenueData: revenueData,
                longCustomerData: longCustomerData,
                monthlyTarget: currentMonthlyTarget,
                workSchedule: {
                    pattern: "4å‹¤å‹™2ä¼‘ã¿",
                    referenceDate: "2026å¹´2æœˆ1æ—¥ï¼ˆ3å‹¤å‹™ç›®ï¼‰",
                    monthlyWorkDays: workScheduleCalc.calculateMonthlyWorkDays(new Date().getFullYear(), new Date().getMonth())
                },
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `taxi-magi-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                localStorage.removeItem('taxiRevenue');
                localStorage.removeItem('longCustomerData');
                localStorage.removeItem('monthlyTarget');
                revenueData = [];
                longCustomerData = [];
                updateDisplay();
                updateChart();
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
            }
        }
    </script>
</body>
</html>
